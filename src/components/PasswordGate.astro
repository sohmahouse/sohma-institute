---
import sohmaLogo from '../assets/images/sohma_house_logo_mockup.svg?raw'

interface Props {
  password: string
  storageKey?: string
}

const { password, storageKey = 'sohma-access' } = Astro.props
---

<div class="password-gate" id="password-gate" data-pw={password} data-key={storageKey}>
  <div class="gate-inner">
    <a href="/" class="gate-logo" aria-label="Sohma House">
      <span class="gate-logo-svg" set:html={sohmaLogo} />
    </a>
    <p class="gate-label">This document is confidential</p>
    <form class="gate-form" id="gate-form">
      <input
        type="password"
        class="gate-input"
        id="gate-input"
        placeholder="Enter password"
        autocomplete="new-password"
        autofocus
      />
      <button type="submit" class="gate-btn">Access</button>
    </form>
    <p class="gate-error" id="gate-error">Incorrect password</p>
  </div>
</div>

<style>
  .password-gate {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 999;
    background: rgba(248, 246, 243, 0.7);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .password-gate.unlocked {
    display: none;
  }

  .gate-inner {
    text-align: center;
    max-width: 360px;
    padding: 0 24px;
  }

  .gate-logo {
    display: inline-block;
    text-decoration: none;
  }

  .gate-logo-svg {
    display: flex;
    height: 48px;
    justify-content: center;
  }

  .gate-logo-svg :global(svg) {
    height: 48px;
    width: auto;
    fill: #c45a42;
  }

  .gate-logo-svg :global(svg path),
  .gate-logo-svg :global(svg *) {
    fill: #c45a42;
  }

  .gate-label {
    font-family: 'Manrope', sans-serif;
    font-size: 13px;
    color: #8a7e74;
    margin-top: 12px;
    margin-bottom: 32px;
    letter-spacing: 0.5px;
  }

  .gate-form {
    display: flex;
    gap: 8px;
  }

  .gate-input {
    flex: 1;
    padding: 14px 16px;
    font-family: 'Manrope', sans-serif;
    font-size: 14px;
    color: #3d3229;
    background: #fff;
    border: 1px solid rgba(0,0,0,0.12);
    border-radius: 6px;
    outline: none;
    transition: border-color 0.2s;
  }

  .gate-input:focus {
    border-color: #c45a42;
  }

  .gate-input.error {
    border-color: #c45a42;
    animation: shake 0.4s ease;
  }

  .gate-btn {
    padding: 14px 24px;
    font-family: 'Manrope', sans-serif;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #f8f6f3;
    background: #c45a42;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .gate-btn:hover {
    background: #a84b37;
  }

  .gate-error {
    font-family: 'Manrope', sans-serif;
    font-size: 13px;
    color: #c45a42;
    margin-top: 12px;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .gate-error.visible {
    opacity: 1;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-6px); }
    75% { transform: translateX(6px); }
  }
</style>

<script>
  function initPasswordGate() {
    const gate = document.getElementById('password-gate') as HTMLElement
    if (!gate) return

    const pw = gate.dataset.pw
    const key = gate.dataset.key || 'sohma-access'
    const form = document.getElementById('gate-form') as HTMLFormElement
    const input = document.getElementById('gate-input') as HTMLInputElement
    const error = document.getElementById('gate-error') as HTMLElement

    // Check if already authenticated
    if (sessionStorage.getItem(key) === 'true') {
      gate.classList.add('unlocked')
      return
    }

    input?.addEventListener('input', () => {
      error.classList.remove('visible')
      input.classList.remove('error')
    })

    form?.addEventListener('submit', (e) => {
      e.preventDefault()
      if (input.value === pw) {
        sessionStorage.setItem(key, 'true')
        gate.classList.add('unlocked')
      } else {
        input.classList.add('error')
        error.classList.add('visible')
        setTimeout(() => {
          input.classList.remove('error')
        }, 400)
        input.value = ''
        input.focus()
      }
    })
  }

  document.addEventListener('DOMContentLoaded', initPasswordGate)
  document.addEventListener('astro:page-load', initPasswordGate)
</script>
