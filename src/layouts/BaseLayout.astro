---
import { ViewTransitions } from 'astro:transitions'

interface Props {
  title: string
  description?: string
}

const { title, description = 'Sohma Institute â€” Practitioner knowledge base for evidence-informed cannabis care.' } = Astro.props
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta property="og:title" content={`${title} | Sohma Institute`} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content="https://sohma.institute/og-image.png" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content="https://sohma.institute/og-image.png" />
    <link rel="preload" href="/fonts/Manrope-Variable.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/CormorantGaramond-Regular.woff2" as="font" type="font/woff2" crossorigin />
    <title>{title} | Sohma Institute</title>

    <script is:inline>
      // Restore theme before render to prevent flash (initial load)
      (function() {
        const stored = localStorage.getItem('sohma-theme')
        if (stored === 'dark' || (!stored && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.setAttribute('data-theme', 'dark')
        }
      })()
      // Preserve theme across View Transitions (before DOM swap)
      document.addEventListener('astro:before-swap', function(e) {
        var stored = localStorage.getItem('sohma-theme')
        if (stored === 'dark' || (!stored && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          e.newDocument.documentElement.setAttribute('data-theme', 'dark')
        }
        e.newDocument.body.classList.add('ready')
      })
    </script>
    <style is:inline>
      .portal-layout{display:flex;min-height:100vh}
      .portal-sidebar-right{width:260px;flex-shrink:0;overflow:hidden}
      @media(max-width:1280px){.portal-sidebar-right{display:none}}
      body:not(.ready){opacity:0}
      body.ready{opacity:1;transition:opacity .12s ease-out}
    </style>
    <ViewTransitions />
  </head>
  <body>
    <script is:inline>requestAnimationFrame(function(){document.body.classList.add('ready')})</script>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <canvas id="grain-canvas" aria-hidden="true" style="position:fixed;inset:0;z-index:9999;pointer-events:none;width:100%;height:100%;opacity:0.06;"></canvas>
    <slot />
    <script is:inline data-astro-rerun>
      function __grainInit() {
        if (window.__grainCleanup) { window.__grainCleanup(); window.__grainCleanup = null }

        const canvas = document.getElementById('grain-canvas')
        if (!canvas) return
        const ctx = canvas.getContext('2d')
        if (!ctx) return

        let w, h, animId = 0

        function resize() {
          w = canvas.width = window.innerWidth
          h = canvas.height = window.innerHeight
        }
        resize()
        window.addEventListener('resize', resize)

        function noise() {
          const imgData = ctx.createImageData(w, h)
          const data = imgData.data
          for (let i = 0; i < data.length; i += 4) {
            const v = (Math.random() * 255) | 0
            data[i] = v
            data[i + 1] = v
            data[i + 2] = v
            data[i + 3] = 140
          }
          ctx.putImageData(imgData, 0, 0)
        }

        let lastTime = 0
        function loop(time) {
          if (time - lastTime > 83) {
            lastTime = time
            noise()
          }
          animId = requestAnimationFrame(loop)
        }
        animId = requestAnimationFrame(loop)

        window.__grainCleanup = function() {
          if (animId) cancelAnimationFrame(animId)
          window.removeEventListener('resize', resize)
        }
      }
      __grainInit()
    </script>
  </body>
</html>

<style is:global>
  @import '../styles/global.css';
</style>
