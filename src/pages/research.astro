---
import PortalLayout from '../layouts/PortalLayout.astro'
---

<PortalLayout
  title="Research — Sohma Institute"
  description="Developing methodologies appropriate to the complexity of traditional medicine interventions. Six research programs, a clinical translation pipeline, and an ethics architecture built on Indigenous Data Sovereignty."
>
  <article class="research-page">

    <!-- HERO -->
    <header class="research-hero">
      <div class="hero-inner">
        <div class="hero-columns">
          <div class="hero-left">
            <div class="section-label">Research Programs</div>
            <h1 class="hero-title">Research That Preserves What It Studies</h1>
            <p class="hero-lead">Developing research methodologies appropriate to the complexity of traditional medicine interventions — whole-systems design, adaptive protocols, and practice-based evidence networks.</p>
          </div>
          <div class="hero-right">
            <div class="hero-partner">
              <div class="hero-partner-header">
                <span class="hero-partner-label">Research Partnership</span>
                <div class="hero-partner-line"></div>
              </div>
              <img src="/images/jcu-logo.svg" alt="James Cook University" class="hero-partner-logo" />
              <div class="hero-partner-pillars">
                <div class="hero-partner-pillar">
                  <span class="pillar-icon">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
                  </span>
                  <span>Applied Research Pipelines</span>
                </div>
                <div class="hero-partner-pillar">
                  <span class="pillar-icon">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                  </span>
                  <span>CPD Pathways</span>
                </div>
                <div class="hero-partner-pillar">
                  <span class="pillar-icon">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                  </span>
                  <span>Clinical Governance</span>
                </div>
              </div>
              <p class="hero-partner-desc">Anchored in Tropical North Queensland — embedding clinical research and practitioner training within a living healthcare model.</p>
            </div>
          </div>
        </div>
      </div>
    </header>


    <!-- RESEARCH PROGRAMS -->
    <section class="programs-section" id="programs">
      <div class="programs-filters" id="programs-filters">
        <button class="program-filter active" data-division="All" type="button">
          All
          <span class="program-filter-count">6</span>
        </button>
        <button class="program-filter" data-division="Division I" type="button">
          Division I
          <span class="program-filter-count">2</span>
        </button>
        <button class="program-filter" data-division="Division II" type="button">
          Division II
          <span class="program-filter-count">1</span>
        </button>
        <button class="program-filter" data-division="Division V" type="button">
          Division V
          <span class="program-filter-count">1</span>
        </button>
        <button class="program-filter" data-division="Cross-Divisional" type="button">
          Cross-Divisional
          <span class="program-filter-count">2</span>
        </button>
      </div>

      <div class="programs-wrap">
        <div class="programs-grid">
          <div class="program-card" data-division="Division I">
            <span class="program-num">01</span>
            <h3 class="program-title">Phytochemical Synergy Mapping</h3>
            <p class="program-subtitle">Network pharmacology analysis of traditional formulae to identify synergistic mechanisms that single-compound analysis cannot detect.</p>

            <div class="program-accordion">Computational and empirical investigation of multi-constituent botanical preparations. The signature deliverable is the first open-access database mapping traditional herbal combinations to validated network pharmacology profiles.</div>
            <div class="program-footer">
              <span class="program-division">Division I</span>
              <span class="program-status status-active">Active</span>
            </div>
          </div>

          <div class="program-card" data-division="Division II">
            <span class="program-num">02</span>
            <h3 class="program-title">Cannabis Clinical Outcomes Registry</h3>
            <p class="program-subtitle">Practice-based evidence network aggregating clinical outcomes from Sohma House and partner prescriber sites.</p>

            <div class="program-accordion">Standardised outcome measures across condition categories. Real-world evidence generation at scale — the kind of data the TGA needs for regulatory pathway development. Feeds directly into TGA submissions and clinical protocol refinement.</div>
            <div class="program-footer">
              <span class="program-division">Division II</span>
              <span class="program-status status-active">Active</span>
            </div>
          </div>

          <div class="program-card" data-division="Cross-Divisional">
            <span class="program-num">03</span>
            <h3 class="program-title">Whole-Systems Research Design</h3>
            <p class="program-subtitle">Research about how to do research. Methodological innovation for complex, multi-component interventions.</p>

            <div class="program-accordion">Preserve intervention complexity rather than reducing it to fit existing trial designs. The contribution is a published methodology framework that other institutions can adopt — proof that rigorous evidence doesn't require destroying the thing you're studying.</div>
            <div class="program-footer">
              <span class="program-division">Cross-Divisional</span>
              <span class="program-status design">In Design</span>
            </div>
          </div>

          <div class="program-card" data-division="Division I">
            <span class="program-num">04</span>
            <h3 class="program-title">Tropical &amp; Indigenous Pharmacopoeia</h3>
            <p class="program-subtitle">Documentation and clinical validation of Far North Queensland botanical resources under Indigenous Data Sovereignty.</p>

            <div class="program-accordion">Supporting communities to document and validate their own traditions using modern analytical tools, with community ownership of all data and outputs. Operates under AIATSIS guidelines and community-controlled data governance.</div>
            <div class="program-footer">
              <span class="program-division">Division I</span>
              <span class="program-status design">In Design</span>
            </div>
          </div>

          <div class="program-card" data-division="Division V">
            <span class="program-num">05</span>
            <h3 class="program-title">Consciousness &amp; Somatic Therapeutics</h3>
            <p class="program-subtitle">Clinical investigation of meditation, breathwork, and somatic practices as measurable interventions.</p>

            <div class="program-accordion">Standardised dosing for practices historically treated as unmeasurable. Neuroimaging partnerships to establish biomarker correlates. Moving these interventions from "wellness" into the same evidentiary category as pharmacological treatments.</div>
            <div class="program-footer">
              <span class="program-division">Division V</span>
              <span class="program-status seeking">Seeking Funding</span>
            </div>
          </div>

          <div class="program-card" data-division="Cross-Divisional">
            <span class="program-num">06</span>
            <h3 class="program-title">AI-Augmented Clinical Decision Support</h3>
            <p class="program-subtitle">Machine learning models trained on traditional medicine diagnostic frameworks.</p>

            <div class="program-accordion">Constitutional classification systems, pattern recognition methodologies, and multi-target therapeutic logic. Augmenting clinical reasoning, not replacing it — surfacing pattern matches a human clinician might miss.</div>
            <div class="program-footer">
              <span class="program-division">Cross-Divisional</span>
              <span class="program-status design">In Design</span>
            </div>
          </div>
        </div>

      </div>
    </section>


    <!-- CLINICAL TRANSLATION PIPELINE -->
    <section class="pipeline-section" id="pipeline">
      <div class="spiral-scroll-outer" id="spiral-scroll-outer">
        <div class="spiral-scroll-sticky">
          <div class="spiral-sidebar">
            <h2 class="section-heading">Clinical Translation Pipeline</h2>
            <p class="section-intro">Every funder and reviewer asks the same question: <em>so what happens with the research?</em> It goes straight into clinical practice through Sohma House and the practitioner network. Clinical data flows back into research refinement. The loop is closed by design.</p>
            <div class="spiral-labels" id="spiral-labels">
              <div class="spiral-labels-track" id="spiral-labels-track">
              <div class="spiral-label" data-node="1">
                <span class="spiral-num">01</span>
                <h3>Research Hypothesis</h3>
                <p>Clinical questions are identified directly from practice-based observation, patient outcomes, and traditional knowledge systems. Practitioners surface the gaps that matter most — the questions that academic research hasn't asked yet.</p>
                <div class="stage-flow">
                  <span class="flow-before">Clinical observation</span>
                  <span class="flow-arrow"></span>
                  <span class="flow-after">Defined research question</span>
                </div>
              </div>
              <div class="spiral-label" data-node="2">
                <span class="spiral-num">02</span>
                <h3>Protocol Design</h3>
                <p>Whole-systems trial methodology designed to preserve intervention complexity rather than reduce it. Protocols account for multi-compound formulations, individualised dosing, and the practitioner-patient relationship as a variable.</p>
                <div class="stage-flow">
                  <span class="flow-before">Research question</span>
                  <span class="flow-arrow"></span>
                  <span class="flow-after">Trial-ready protocol</span>
                </div>
              </div>
              <div class="spiral-label" data-node="3">
                <span class="spiral-num">03</span>
                <h3>Clinical Pilot</h3>
                <p>Small-scale implementation through Sohma House and partner clinics. Real patients, real conditions, real-world constraints. Pilot data validates feasibility before scaling and identifies protocol adjustments early.</p>
                <div class="stage-flow">
                  <span class="flow-before">Protocol on paper</span>
                  <span class="flow-arrow"></span>
                  <span class="flow-after">Feasibility-validated pilot</span>
                </div>
              </div>
              <div class="spiral-label" data-node="4">
                <span class="spiral-num">04</span>
                <h3>Data Collection</h3>
                <p>Standardised outcome measurement across the practitioner network. Registry-level data aggregation captures what isolated trials cannot — longitudinal patterns, demographic variance, and combination therapy effects at scale.</p>
                <div class="stage-flow">
                  <span class="flow-before">Individual case data</span>
                  <span class="flow-arrow"></span>
                  <span class="flow-after">Network-wide dataset</span>
                </div>
              </div>
              <div class="spiral-label" data-node="5">
                <span class="spiral-num">05</span>
                <h3>Refinement</h3>
                <p>Protocols are adjusted based on clinical outcomes and practitioner feedback. This isn't a single revision — it's a continuous feedback loop where each iteration sharpens dosing, timing, and patient selection criteria.</p>
                <div class="stage-flow">
                  <span class="flow-before">Raw outcome data</span>
                  <span class="flow-arrow"></span>
                  <span class="flow-after">Optimised protocol</span>
                </div>
              </div>
              <div class="spiral-label" data-node="6">
                <span class="spiral-num">06</span>
                <h3>Validated Protocol</h3>
                <p>Peer-reviewed publication and formal evidence tier classification. Validated protocols carry clear confidence ratings so practitioners understand exactly what the evidence supports and where further research is needed.</p>
                <div class="stage-flow">
                  <span class="flow-before">Clinical evidence</span>
                  <span class="flow-arrow"></span>
                  <span class="flow-after">Peer-reviewed validation</span>
                </div>
              </div>
              <div class="spiral-label" data-node="7">
                <span class="spiral-num">07</span>
                <h3>Network Distribution</h3>
                <p>Validated protocols are distributed to credentialed practitioners through the network infrastructure. Training materials, dosing guides, and clinical decision support tools ensure consistent implementation across all partner sites.</p>
                <div class="stage-flow">
                  <span class="flow-before">Validated protocol</span>
                  <span class="flow-arrow"></span>
                  <span class="flow-after">Network-wide practice</span>
                </div>
              </div>
              </div>
            </div>
          </div>
          <div class="spiral-wrap">
            <canvas id="pipeline-canvas" class="pipeline-canvas" aria-hidden="true"></canvas>
          </div>
        </div>
      </div>

      <div class="tiers-row">
        <div class="tier-card">
          <div class="tier-header">
            <span class="tier-letter green">A</span>
            <span class="tier-name">Validated</span>
          </div>
          <p>Completed clinical pilot, peer-reviewed publication, network-wide distribution. Available to all credentialed practitioners.</p>
        </div>
        <div class="tier-card">
          <div class="tier-header">
            <span class="tier-letter warm">B</span>
            <span class="tier-name">Provisional</span>
          </div>
          <p>Active clinical pilot with preliminary data. Available under supervision framework for Associate and Fellow practitioners.</p>
        </div>
        <div class="tier-card">
          <div class="tier-header">
            <span class="tier-letter neutral">C</span>
            <span class="tier-name">Investigational</span>
          </div>
          <p>Research design phase. Not available outside research settings. Active data collection underway.</p>
        </div>
      </div>

      <p class="pipeline-note">The pipeline is bidirectional. Practitioners submit outcome data, adverse events, and protocol modification requests through a standardised reporting system. This data feeds directly into research program refinement.</p>
    </section>


    <!-- RESEARCH ETHICS -->
    <section class="ethics-section" id="ethics">
      <h2 class="section-heading">Research Ethics Architecture</h2>
      <p class="section-intro">This is not a footnote. It is constitutionally embedded in the Institute's governance and non-negotiable.</p>

      <div class="ethics-grid">
        <div class="ethics-card">
          <div class="ethics-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          </div>
          <h3>Indigenous Data Sovereignty</h3>
          <div class="ethics-field">
            <span class="ethics-field-label">Framework</span>
            <p>All research involving Indigenous knowledge systems operates under AIATSIS guidelines and community-controlled data governance. The Institute does not extract traditional knowledge — it supports communities to document and validate their own traditions, with community ownership of all data and outputs.</p>
          </div>
          <div class="ethics-field">
            <span class="ethics-field-label">Governance</span>
            <p>The <a href="/#about">Indigenous Advisory Council</a> holds veto authority over any research, curriculum, or publication involving Indigenous knowledge systems. This authority is constitutionally mandated, not advisory.</p>
          </div>
        </div>
        <div class="ethics-card">
          <div class="ethics-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
          </div>
          <h3>Open Access Commitment</h3>
          <div class="ethics-field">
            <span class="ethics-field-label">Position</span>
            <p>All Institute-generated research is published under open access licences. Traditional medicine knowledge was never proprietary. It emerged from communities, was refined through millennia of practice, and belongs to humanity. The Institute's role is translation and validation, not enclosure.</p>
          </div>
          <div class="ethics-field">
            <span class="ethics-field-label">Charter Prohibition</span>
            <p>Patent-seeking on traditional knowledge is explicitly prohibited in the Institute charter. This is a constitutional prohibition that cannot be overridden by management, the board, or future leadership.</p>
          </div>
        </div>
      </div>
    </section>



  </article>
</PortalLayout>

<style>
  .research-page {
    font-family: 'Manrope', sans-serif;
    color: var(--text-heading);
    padding: 0;
  }
  .research-page p { line-height: 1.8; margin: 0 0 1rem; }
  .research-page p:last-child { margin-bottom: 0; }
  .research-page h2, .research-page h3 { margin: 0 0 14px; }
  .research-page a { color: var(--accent-dark); text-decoration: none; }
  .research-page a:hover { color: var(--accent-darker-hover); }


  /* ═══════════ HERO ═══════════ */
  .research-hero {
    position: relative;
    max-width: none;
    margin: 0 -40px;
    padding: 0;
    background: var(--bg-hero);
  }

  .hero-inner {
    position: relative;
    z-index: 1;
    padding: 96px calc(2rem + 40px) 64px calc(1rem + 40px);
  }

  .hero-columns {
    display: grid;
    grid-template-columns: 1fr 260px;
    gap: 3rem;
    align-items: start;
  }

  .hero-left {
    min-width: 0;
  }

  .hero-right {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
    padding-top: 0.25rem;
  }

  .hero-partner {
    display: flex;
    flex-direction: column;
    gap: 16px;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    padding: 24px;
    background: var(--bg-card);
  }

  .hero-partner-header {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .hero-partner-label {
    font-family: 'Manrope', sans-serif;
    font-size: 0.5625rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: var(--accent);
    white-space: nowrap;
  }

  .hero-partner-line {
    flex: 1;
    height: 1px;
    background: var(--border-light);
  }

  .hero-partner-logo {
    width: 120px;
    height: auto;
    opacity: 0.6;
    filter: invert(1);
    align-self: center;
  }

  :global([data-theme="dark"]) .hero-partner-logo {
    filter: none;
  }

  .hero-partner-pillars {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 6px;
  }

  .hero-partner-pillar {
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'Manrope', sans-serif;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .pillar-icon {
    color: var(--accent);
    opacity: 0.6;
    flex-shrink: 0;
    display: flex;
  }

  .hero-partner-desc {
    font-family: 'Manrope', sans-serif;
    font-size: 0.6875rem;
    font-weight: 400;
    color: var(--text-tertiary);
    line-height: 1.6;
    margin: 0;
    padding-top: 14px;
    margin-top: 4px;
    border-top: 1px solid var(--border-light);
  }

  .section-label {
    display: flex;
    align-items: center;
    gap: 12px;
    font-family: 'Manrope', sans-serif;
    font-size: 0.6875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: var(--accent-dark);
    margin-bottom: 2rem;
  }
  .section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--accent-line);
  }

  .hero-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(2.5rem, 5vw, 4.75rem);
    font-weight: 500;
    line-height: 1.1;
    letter-spacing: -0.01em;
    color: var(--text-heading);
    max-width: 700px;
    margin: 0 0 24px;
  }

  .hero-lead {
    font-size: 1.0625rem;
    color: var(--text-secondary);
    line-height: 1.65;
    max-width: none;
    padding-left: 1.5rem;
    margin-bottom: 2rem;
  }

  .hero-cta-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding-left: 0;
    margin-top: 3rem;
  }

  .research-page .hero-cta-primary {
    display: inline-block;
    font-family: 'Manrope', sans-serif;
    font-size: 0.8125rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    color: var(--text-heading);
    background: var(--accent-dark);
    padding: 12px 28px;
    transition: background 0.15s;
  }
  .research-page .hero-cta-primary:hover { background: var(--accent-darker-hover); color: var(--text-heading); }

  .research-page .hero-cta-secondary {
    display: inline-block;
    font-family: 'Manrope', sans-serif;
    font-size: 0.8125rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    color: var(--text-secondary);
    border: 1px solid var(--border-medium);
    padding: 12px 28px;
    transition: border-color 0.15s, color 0.15s;
  }
  .research-page .hero-cta-secondary:hover { border-color: var(--accent-dark); color: var(--accent-dark); }


  /* ═══════════ SECTION HEADINGS ═══════════ */
  .section-heading {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2.5rem;
    font-weight: 400;
    color: var(--text-heading);
    line-height: 1.15;
    margin-bottom: 1rem;
    letter-spacing: -0.01em;
  }

  .section-heading + .section-intro {
    margin-top: -0.25rem;
  }

  .section-intro {
    font-size: 0.9375rem;
    color: var(--text-secondary);
    line-height: 1.65;
    max-width: 640px;
    margin-bottom: 2.5rem;
  }

  .programs-section .section-heading {
    margin-bottom: 1rem;
  }


  /* ═══════════ PIPELINE ═══════════ */
  .pipeline-section {
    position: relative;
    padding: 0;
    border-bottom: 1px solid var(--border-light);
  }

  .spiral-scroll-outer {
    position: relative;
    height: 420vh;
  }

  .spiral-scroll-sticky {
    position: sticky;
    top: 0;
    height: 100vh;
    display: flex;
    align-items: center;
    gap: 2rem;
    overflow: visible;
    padding-right: 4rem;
  }

  .spiral-sidebar {
    flex: 0 0 420px;
    padding: 0 0 2rem 0;
    align-self: flex-start;
    margin-top: 6rem;
    margin-left: -2rem;
    z-index: 2;
    order: 2;
  }

  .spiral-sidebar .section-heading {
    font-size: 3rem;
    margin-bottom: 1.5rem;
    margin-left: -2rem;
    line-height: 1.15;
  }

  .spiral-sidebar .section-intro {
    font-size: 0.95rem;
    line-height: 1.7;
    color: var(--text-body-60);
  }

  .spiral-wrap {
    position: relative;
    flex: 1;
    height: 700px;
    margin-left: -2rem;
  }

  .pipeline-canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
  }

  .spiral-labels {
    position: relative;
    margin-top: 2.5rem;
    overflow: hidden;
    height: 430px;
    -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 75%, transparent 100%);
    mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 75%, transparent 100%);
  }

  .spiral-labels-track {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    will-change: transform;
  }

  .spiral-label {
    text-align: left;
    padding: 1.5rem 1.75rem 1.25rem;
    background: rgba(255, 255, 255, 0.04);
    border-left: 2px solid var(--accent-dark);
    border-radius: 0 4px 4px 0;
  }

  .spiral-label + .spiral-label {
    margin-top: 0.75rem;
  }

  [data-theme="light"] .spiral-label {
    background: rgba(0, 0, 0, 0.03);
  }

  .spiral-num {
    display: block;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--accent-dark);
    opacity: 0.35;
    margin-bottom: 0.4rem;
  }

  .spiral-label h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-heading);
    line-height: 1.2;
    margin-bottom: 0.6rem;
  }

  .spiral-label p {
    font-size: 0.85rem;
    color: var(--text-body-60);
    line-height: 1.6;
    margin: 0;
    max-width: 280px;
  }

  /* ── Before → After flow indicator ── */
  .stage-flow {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1.1rem;
    padding-top: 0.9rem;
    border-top: 1px solid rgba(255, 255, 255, 0.06);
  }

  [data-theme="light"] .stage-flow {
    border-top-color: rgba(0, 0, 0, 0.06);
  }

  .flow-before,
  .flow-after {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.04em;
    line-height: 1.3;
    padding: 0.3rem 0.55rem;
    border-radius: 3px;
    white-space: nowrap;
  }

  .flow-before {
    color: var(--text-body-60);
    background: rgba(255, 255, 255, 0.04);
    opacity: 0.6;
  }

  [data-theme="light"] .flow-before {
    background: rgba(0, 0, 0, 0.04);
  }

  .flow-arrow {
    flex-shrink: 0;
    width: 20px;
    height: 1px;
    background: var(--accent-dark);
    opacity: 0.3;
    position: relative;
  }

  .flow-arrow::after {
    content: '';
    position: absolute;
    right: 0;
    top: -2px;
    border: 2px solid transparent;
    border-left: 3px solid var(--accent-dark);
    opacity: 0.4;
  }

  .flow-after {
    color: var(--text-heading);
    background: rgba(255, 255, 255, 0.06);
    opacity: 0.85;
  }

  [data-theme="light"] .flow-after {
    background: rgba(0, 0, 0, 0.05);
  }


  .pipeline-animated .tiers-row,
  .pipeline-animated .pipeline-note {
    position: relative;
    z-index: 1;
  }

  /* Mobile fallback: no spiral, vertical list */
  .spiral-fallback-list {
    display: none;
  }

  .tiers-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.25rem;
    margin-bottom: 2rem;
  }

  .tier-card {
    border: 1px solid var(--border-light);
    padding: 1.5rem;
    transition: border-color 0.2s;
  }

  .tier-card:hover {
    border-color: var(--accent-border-15);
  }

  .tier-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .tier-letter {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Cormorant Garamond', serif;
    font-size: 1rem;
    font-weight: 600;
    flex-shrink: 0;
  }

  .tier-letter.green { color: var(--accent-green); border: 2px solid var(--accent-green); }
  .tier-letter.warm { color: var(--chart-warm); border: 2px solid var(--chart-warm); }
  .tier-letter.neutral { color: var(--text-tertiary); border: 2px solid var(--text-tertiary); }

  .tier-name {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.25rem;
    font-weight: 500;
    color: var(--text-heading);
  }

  .tier-card p {
    font-size: 0.8125rem;
    color: var(--text-body-60);
    line-height: 1.7;
  }

  .research-page p.pipeline-note {
    font-size: 0.8125rem;
    font-style: italic;
    color: var(--text-tertiary);
    line-height: 1.7;
    max-width: 680px;
    margin: 0;
  }


  /* ═══════════ PROGRAMS ═══════════ */
  .programs-section {
    padding: 4rem 0;
    border-bottom: 1px solid var(--border-light);
  }

  /* Filter bar */
  .programs-filters {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0;
    margin-bottom: 2.5rem;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }

  .programs-filters::-webkit-scrollbar {
    display: none;
  }

  .program-filter {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: 'Manrope', sans-serif;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--text-secondary);
    background: var(--bg-card-hover);
    border: 1px solid var(--border-medium);
    border-radius: 4px;
    padding: 8px 14px;
    cursor: pointer;
    white-space: nowrap;
    transition: color 0.15s, background 0.15s, border-color 0.15s;
    flex-shrink: 0;
  }

  .program-filter:hover {
    color: var(--text-heading);
    border-color: var(--accent-border-20);
    background: var(--accent-bg-02);
  }

  .program-filter.active {
    color: var(--accent-dark);
    background: var(--accent-bg-04);
    border-color: var(--accent-border-25);
    font-weight: 600;
  }

  .program-filter-count {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.625rem;
    font-weight: 500;
    color: var(--text-tertiary);
    background: var(--bg-card);
    padding: 1px 6px;
    border-radius: 3px;
    line-height: 1.4;
  }

  .program-filter.active .program-filter-count {
    color: var(--accent-dark);
    background: var(--accent-bg-08);
  }

  .program-card.program-card-hidden {
    display: none;
  }

  .programs-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .program-card {
    display: flex;
    flex-direction: column;
    background: var(--bg-card);
    border: 1px solid var(--border-light);
    border-radius: 6px;
    padding: 24px;
    transition: border-color 0.2s, background 0.2s;
  }

  .program-card:hover {
    border-color: var(--accent-border-15);
  }

  .program-num {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.625rem;
    font-weight: 400;
    letter-spacing: 0.1em;
    color: var(--text-tertiary);
    opacity: 0.7;
    margin-bottom: 8px;
  }

  .program-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.5rem;
    font-weight: 500;
    color: var(--text-heading);
    line-height: 1.25;
    transition: color 0.15s;
  }

  .program-card:hover .program-title {
    color: var(--accent);
  }

  .program-subtitle {
    font-size: 0.875rem;
    font-style: italic;
    color: var(--text-tertiary);
    line-height: 1.25;
    margin: 0 0 12px;
  }

  .program-details-toggle {
    font-family: 'Manrope', sans-serif;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-tertiary);
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: color 0.15s;
  }

  .program-details-toggle::before {
    content: '+';
    font-size: 0.875rem;
    font-weight: 600;
    line-height: 1;
  }

  .program-details-toggle:hover {
    color: var(--text-heading);
  }

  :global(.program-card.program-card-active) {
    border-color: var(--accent-border-25);
    background: var(--accent-bg-02);
  }

  :global(.program-card.program-card-active .program-details-toggle)::before {
    content: '−';
  }

  /* Accordion */
  .program-accordion {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
    opacity: 0;
    font-size: 0.875rem;
    color: var(--text-body-65);
    line-height: 1.7;
    margin: 0;
  }

  :global(.program-card.program-card-active .program-accordion) {
    max-height: 200px;
    opacity: 1;
    margin: 12px 0 0;
  }

  .program-footer {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid var(--border-light);
  }

  .program-cta {
    font-family: 'Manrope', sans-serif;
    font-size: 0.6875rem;
    font-weight: 600;
    color: var(--accent-dark);
    text-decoration: none;
    margin-left: auto;
    white-space: nowrap;
    transition: color 0.15s;
  }

  .program-cta:hover {
    color: var(--accent-darker-hover);
  }

  .program-division,
  .program-status {
    font-family: 'Manrope', sans-serif;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-tertiary);
    background: var(--bg-card-hover);
    padding: 2px 8px;
    border-radius: 3px;
    white-space: nowrap;
  }
  .program-status.status-active { color: var(--text-tertiary); }
  .program-status.design { color: var(--text-tertiary); }
  .program-status.seeking { color: var(--text-tertiary); }


  /* ═══════════ ETHICS ═══════════ */
  .ethics-section {
    padding: 4rem 0;
    border-bottom: 1px solid var(--border-light);
  }

  .ethics-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
  }

  .ethics-card {
    border: 1px solid var(--border-light);
    padding: 2rem;
    transition: border-color 0.2s;
  }

  .ethics-card:hover {
    border-color: var(--accent-border-15);
  }

  .ethics-icon {
    color: var(--accent-dark);
    opacity: 0.5;
    margin-bottom: 1.25rem;
  }

  .ethics-card h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.375rem;
    font-weight: 500;
    color: var(--text-heading);
    margin-bottom: 1.25rem;
  }

  .ethics-field {
    margin-bottom: 1rem;
  }

  .ethics-field:last-child {
    margin-bottom: 0;
  }

  .ethics-field-label {
    display: block;
    font-size: 0.6875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--accent-dark);
    opacity: 0.7;
    margin-bottom: 0.375rem;
  }

  .ethics-field p {
    font-size: 0.875rem;
    color: var(--text-body-65);
    line-height: 1.75;
  }


  /* ═══════════ CTA ═══════════ */
  .collab-cta {
    margin: 0 -40px;
    padding: 0;
    background: #141210;
    border-bottom: none;
  }

  .collab-inner {
    max-width: 640px;
    margin: 0 auto;
    padding: 6rem 2rem;
    text-align: center;
  }

  .cta-eyebrow {
    display: block;
    font-family: 'Manrope', sans-serif;
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: rgba(196, 110, 66, 0.7);
    margin-bottom: 1rem;
  }

  .cta-primary-block h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 3rem;
    font-weight: 400;
    color: #e8dfd0;
    letter-spacing: -0.01em;
    margin: 0 0 1.25rem;
  }

  .cta-primary-block p {
    font-size: 1rem;
    color: rgba(208, 200, 188, 0.55);
    line-height: 1.7;
    max-width: 440px;
    margin: 0 auto 2.5rem;
  }

  .cta-primary-btn {
    display: inline-block;
    padding: 14px 40px;
    font-family: 'Manrope', sans-serif;
    font-size: 0.8125rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    color: #141210;
    background: var(--accent-dark);
    border: none;
    border-radius: 4px;
    text-decoration: none;
    transition: background 0.2s, transform 0.15s;
  }

  .cta-primary-btn:hover {
    background: #d4773a;
    transform: translateY(-1px);
  }

  .cta-secondary-block {
    display: flex;
    justify-content: center;
    gap: 3rem;
    margin-top: 3rem;
    padding-top: 2.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.06);
  }

  .cta-alt {
    text-decoration: none;
    text-align: center;
  }

  .cta-alt-label {
    display: block;
    font-family: 'Manrope', sans-serif;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(208, 200, 188, 0.35);
    margin-bottom: 0.375rem;
  }

  .cta-alt-action {
    display: block;
    font-size: 0.8125rem;
    color: rgba(208, 200, 188, 0.6);
    transition: color 0.2s;
  }

  .cta-alt:hover .cta-alt-action {
    color: #e8dfd0;
  }


  /* ═══════════ DARK MODE ═══════════ */
  :global([data-theme="dark"]) .research-page .hero-cta-primary {
    color: #000;
  }
  :global([data-theme="dark"]) .research-page .hero-cta-primary:hover {
    color: #000;
  }

  :global([data-theme="dark"]) .cta-primary-btn {
    color: #141210;
  }
  :global([data-theme="dark"]) .cta-primary-btn:hover {
    color: #141210;
  }

  :global([data-theme="dark"]) .program-division {
    color: var(--accent);
    background: var(--accent-bg-08);
  }

  :global([data-theme="dark"]) .program-status {
    background: var(--accent-bg-08);
  }

  /* ═══════════ RESPONSIVE ═══════════ */
  @media (max-width: 1024px) {
    .research-hero {
      margin: 0 -20px;
    }
    .hero-inner {
      padding: 64px calc(1.5rem + 20px) 48px calc(1rem + 20px);
    }
    .collab-cta { margin: 0 -20px; }
  }

  @media (max-width: 768px) {
    .hero-inner {
      padding: 48px 1.25rem 36px;
    }
    .research-hero {
      margin: 0 -20px;
    }
    .hero-title { font-size: 2.5rem; }
    .hero-lead { padding-left: 0; }
    .hero-cta-row { padding-left: 0; }
    .hero-columns { grid-template-columns: 1fr; }
    .hero-right { order: -1; gap: 1.5rem; }
    .section-heading { font-size: 2rem; }

    .spiral-scroll-outer { height: auto; }
    .spiral-scroll-sticky { position: static; height: auto; flex-direction: column; }
    .spiral-sidebar { flex: none; width: 100%; padding: 1rem 0; }
    .spiral-wrap { height: auto; }
    .pipeline-canvas { display: none; }
    .spiral-labels {
      height: auto;
      overflow: visible;
    }
    .spiral-labels::after { display: none; }
    .spiral-labels-track {
      position: static !important;
      transform: none !important;
    }
    .spiral-label {
      opacity: 1 !important;
    }

    .tiers-row { grid-template-columns: 1fr; }
    .collab-cta { margin: 0 -20px; }
    .cta-secondary-block { flex-direction: column; gap: 1.5rem; }
    .programs-grid { grid-template-columns: 1fr; }
    .program-card { padding: 20px; }
    .ethics-grid { grid-template-columns: 1fr; }
  }
</style>

<script is:inline>
  function initProgramFilters() {
    var filters = document.getElementById('programs-filters')
    var grid = document.querySelector('.programs-grid')
    if (!filters || !grid) return

    var cards = Array.from(grid.querySelectorAll('.program-card'))

    filters.addEventListener('click', function(e) {
      var btn = e.target.closest('.program-filter')
      if (!btn) return

      var division = btn.dataset.division

      filters.querySelectorAll('.program-filter').forEach(function(f) { f.classList.remove('active') })
      btn.classList.add('active')

      var visibleIndex = 0
      cards.forEach(function(card) {
        var match = division === 'All' || card.dataset.division === division
        if (match) {
          card.classList.remove('program-card-hidden')
          visibleIndex++
          var num = card.querySelector('.program-num')
          if (num) num.textContent = String(visibleIndex).padStart(2, '0')
          var divTag = card.querySelector('.program-division')
          if (divTag) divTag.style.display = division === 'All' ? '' : 'none'
        } else {
          card.classList.add('program-card-hidden')
        }
      })
    })
  }

  function initProgramPanel() {
    var toggles = document.querySelectorAll('.program-details-toggle')
    toggles.forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault()
        var card = btn.closest('.program-card')
        if (!card) return
        if (card.classList.contains('program-card-active')) {
          card.classList.remove('program-card-active')
        } else {
          document.querySelectorAll('.program-card-active').forEach(function(c) {
            c.classList.remove('program-card-active')
          })
          card.classList.add('program-card-active')
        }
      })
    })
  }

  // Run immediately (script is at bottom of page, DOM is ready)
  initProgramFilters()
  initProgramPanel()
  // Also handle view transitions re-navigation
  document.addEventListener('astro:page-load', function() { initProgramFilters(); initProgramPanel(); })
</script>

<script is:inline>
;(function spiralViz() {
  /* ── Preflight ── */
  var reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches
  var section = document.getElementById('pipeline')
  var canvas = document.getElementById('pipeline-canvas')
  var scrollOuter = document.getElementById('spiral-scroll-outer')
  if (!section || !canvas || !scrollOuter) return
  var ctx = canvas.getContext('2d')
  if (!ctx) return
  if (window.innerWidth <= 768) return
  if (reducedMotion) return

  section.classList.add('pipeline-animated')

  /* ── Theme ── */
  function isDark() { return document.documentElement.dataset.theme === 'dark' }

  var COLORS_LIGHT = {
    fwdStart: [220, 130, 40],
    fwdEnd:   [200, 95, 30],
    ret:      [215, 185, 80],
    progress: [230, 180, 80]
  }
  var COLORS_DARK = {
    fwdStart: [235, 145, 50],
    fwdEnd:   [215, 105, 35],
    ret:      [225, 195, 90],
    progress: [240, 200, 100]
  }

  function getColors() { return isDark() ? COLORS_DARK : COLORS_LIGHT }
  function baseAlpha() { return isDark() ? 0.75 : 0.6 }

  function lerpColor(a, b, t) {
    return [a[0]+(b[0]-a[0])*t, a[1]+(b[1]-a[1])*t, a[2]+(b[2]-a[2])*t]
  }

  function rgbStr(c, a) {
    return 'rgba('+Math.round(c[0])+','+Math.round(c[1])+','+Math.round(c[2])+','+a+')'
  }

  /* ── Canvas setup ── */
  var wrap = section.querySelector('.spiral-wrap')
  var labels = section.querySelectorAll('.spiral-label')
  var labelsTrack = document.getElementById('spiral-labels-track')
  var labelOffsets = [] // top offset of each label within the track
  var currentTrackY = 0 // lerp-smoothed carousel position
  var W = 0, H = 0, dpr = 1
  var animId = 0, visible = false, time = 0
  var hoveredNode = -1
  var activeNode = -1
  var resizeTimer = 0
  var progressT = 0
  var prevProgressT = 0

  /* ── Spiral geometry ── */
  var TOTAL_THETA = Math.PI * 5    // ~2.5 turns
  var NODE_COUNT = 8
  var nodeTs = []                   // t-values for each node (0-1)
  var nodePositions = []            // {x, y} for each node
  var spiralA = 20                  // inner radius
  var spiralB = 0                   // computed on resize
  var cx = 0, cy = 0               // center

  var HELIX_CYCLES = 30     // number of uniform oscillations along spiral
  var HELIX_AMP  = 8        // px displacement from spiral backbone
  var HELIX_WAVE = 0        // computed: 2π * HELIX_CYCLES / totalArcLength

  // Arc-length lookup for uniform helix spacing
  var ARC_STEPS = 300
  var arcLens = new Float32Array(ARC_STEPS + 1)

  function computeArcLengths() {
    arcLens[0] = 0
    var prev = spiralPos(0)
    for (var i = 1; i <= ARC_STEPS; i++) {
      var cur = spiralPos(i / ARC_STEPS)
      var dx = cur.x - prev.x, dy = cur.y - prev.y
      arcLens[i] = arcLens[i - 1] + Math.sqrt(dx * dx + dy * dy)
      prev = cur
    }
    HELIX_WAVE = Math.PI * 2 * HELIX_CYCLES / arcLens[ARC_STEPS]
  }

  function arcAtT(t) {
    var idx = t * ARC_STEPS
    var lo = Math.floor(idx)
    if (lo >= ARC_STEPS) return arcLens[ARC_STEPS]
    var hi = lo + 1
    var frac = idx - lo
    return arcLens[lo] + (arcLens[hi] - arcLens[lo]) * frac
  }

  var NODE_END = 0.92  // nodes span 0 to 0.92
  for (var i = 0; i < NODE_COUNT; i++) {
    nodeTs.push((i / (NODE_COUNT - 1)) * NODE_END)
  }

  var SPIN_SPEED = 0.08 // radians per second
  var spinOffset = 0 // cached per frame

  function spiralPos(t) {
    var theta = t * TOTAL_THETA + spinOffset
    var r = spiralA + spiralB * (t * TOTAL_THETA)
    return { x: cx + r * Math.cos(theta), y: cy + r * Math.sin(theta) }
  }

  function spiralTangent(t) {
    var theta = t * TOTAL_THETA + spinOffset
    var r = spiralA + spiralB * (t * TOTAL_THETA)
    var dr = spiralB * TOTAL_THETA
    var ct = Math.cos(theta), st = Math.sin(theta)
    return {
      x: dr * ct - r * st * TOTAL_THETA,
      y: dr * st + r * ct * TOTAL_THETA
    }
  }

  function computeSpiral() {
    var maxR = Math.min(W, H) * 0.46
    spiralB = (maxR - spiralA) / TOTAL_THETA
    cx = W / 2
    cy = H / 2
    computeArcLengths()

    nodePositions = []
    for (var i = 0; i < NODE_COUNT; i++) {
      nodePositions.push(spiralPos(nodeTs[i]))
    }
  }

  /* ── Scroll progress ── */
  function getScrollProgress() {
    var rect = scrollOuter.getBoundingClientRect()
    var total = scrollOuter.offsetHeight - window.innerHeight
    if (total <= 0) return 0
    return Math.max(0, Math.min(1, -rect.top / total))
  }

  /* ── Particle pools ── */
  // Forward particles (helix strand A) — spawn from center + boosted from nodes
  var FWD_COUNT = 2000
  var FWD_STRIDE = 7 // [t, speed, active, jitter, sinePhase, size, _]
  var fwd = new Float32Array(FWD_COUNT * FWD_STRIDE)

  // Return helix particles (helix strand B) — spiral back from progressT
  var RH_COUNT = 900
  var RH_STRIDE = 6 // [t, speed, active, sinePhase, size, _]
  var rh = new Float32Array(RH_COUNT * RH_STRIDE)

  var nodeGlow = new Float32Array(NODE_COUNT)

  // Sacred geometry petal returns — particles arc back to center in flower-of-life curves
  var GEO_COUNT = 1200
  var GEO_STRIDE = 8 // [startX, startY, ctrlX, ctrlY, progress, speed, curveSide, active]
  var geo = new Float32Array(GEO_COUNT * GEO_STRIDE)
  var GEO_AXES = 6 // hexagonal symmetry
  var geoAxAngles = []
  for (var g = 0; g < GEO_AXES; g++) geoAxAngles.push(g * Math.PI * 2 / GEO_AXES)

  /* ── Spawn ── */
  var fwdAccum = 0, fwdNodeAccum = 0, rhAccum = 0

  function spawnFwd() {
    if (progressT < 0.01) return
    // From center
    fwdAccum += 12 + Math.random() * 8
    var toSpawn = Math.floor(fwdAccum)
    if (toSpawn > 0) {
      fwdAccum -= toSpawn
      for (var i = 0; i < FWD_COUNT && toSpawn > 0; i++) {
        var b = i * FWD_STRIDE
        if (fwd[b + 2] === 0) {
          fwd[b]     = Math.random() * 0.005
          fwd[b + 1] = 0.0002 + Math.random() * 0.0025
          fwd[b + 2] = 1
          fwd[b + 3] = (Math.random() - 0.5) * 12
          fwd[b + 4] = Math.random() * Math.PI * 2
          fwd[b + 5] = 1 + Math.random() * 2.5
          toSpawn--
        }
      }
    }
    // From reached nodes (boost — each node emits forward particles)
    var reached = []
    for (var n = 0; n < NODE_COUNT; n++) {
      if (progressT >= nodeTs[n] + 0.01 && nodeTs[n] < progressT - 0.02) reached.push(n)
    }
    if (reached.length === 0) return
    fwdNodeAccum += (5 + Math.random() * 3) * reached.length
    var nodeSpawn = Math.floor(fwdNodeAccum)
    if (nodeSpawn <= 0) return
    fwdNodeAccum -= nodeSpawn
    for (var i = 0; i < FWD_COUNT && nodeSpawn > 0; i++) {
      var b = i * FWD_STRIDE
      if (fwd[b + 2] === 0) {
        var ni = reached[Math.floor(Math.random() * reached.length)]
        fwd[b]     = nodeTs[ni] + Math.random() * 0.01
        fwd[b + 1] = 0.0003 + Math.random() * 0.003
        fwd[b + 2] = 1
        fwd[b + 3] = (Math.random() - 0.5) * 10
        fwd[b + 4] = Math.random() * Math.PI * 2
        fwd[b + 5] = 1 + Math.random() * 2.5
        nodeSpawn--
      }
    }
  }

  function spawnRetHelix() {
    if (progressT < 0.08) return
    rhAccum += 7 + Math.random() * 5
    var toSpawn = Math.floor(rhAccum)
    if (toSpawn <= 0) return
    rhAccum -= toSpawn
    for (var i = 0; i < RH_COUNT && toSpawn > 0; i++) {
      var b = i * RH_STRIDE
      if (rh[b + 2] === 0) {
        rh[b]     = progressT * 0.75 + Math.random() * progressT * 0.2
        rh[b + 1] = 0.0003 + Math.random() * 0.001
        rh[b + 2] = 1
        rh[b + 3] = Math.random() * Math.PI * 2
        rh[b + 4] = 0.8 + Math.random() * 1.8
        toSpawn--
      }
    }
  }

  /* ── Draw double-helix guide paths (up to progressT) ── */
  function drawSpiralPath() {
    if (progressT < 0.005) return
    var c = getColors()
    var steps = Math.max(2, Math.floor(300 * progressT))
    // Strand A (forward helix)
    ctx.beginPath()
    for (var i = 0; i <= steps; i++) {
      var t = (i / 300) // keep same parametric density
      if (t > progressT) break
      var theta = t * TOTAL_THETA
      var p = spiralPos(t)
      var tan = spiralTangent(t)
      var len = Math.sqrt(tan.x * tan.x + tan.y * tan.y) || 1
      var nx = -tan.y / len, ny = tan.x / len
      var d = HELIX_AMP * Math.sin(HELIX_WAVE * arcAtT(t))
      var hx = p.x + nx * d, hy = p.y + ny * d
      if (i === 0) ctx.moveTo(hx, hy)
      else ctx.lineTo(hx, hy)
    }
    ctx.strokeStyle = 'rgba(255,255,255,0.06)'
    ctx.lineWidth = 0.5
    ctx.stroke()

    // Strand B (return helix — π out of phase)
    ctx.beginPath()
    for (var i = 0; i <= steps; i++) {
      var t = (i / 300)
      if (t > progressT) break
      var theta = t * TOTAL_THETA
      var p = spiralPos(t)
      var tan = spiralTangent(t)
      var len = Math.sqrt(tan.x * tan.x + tan.y * tan.y) || 1
      var nx = -tan.y / len, ny = tan.x / len
      var d = HELIX_AMP * Math.sin(HELIX_WAVE * arcAtT(t) + Math.PI)
      var hx = p.x + nx * d, hy = p.y + ny * d
      if (i === 0) ctx.moveTo(hx, hy)
      else ctx.lineTo(hx, hy)
    }
    ctx.strokeStyle = 'rgba(255,255,255,0.06)'
    ctx.lineWidth = 0.5
    ctx.stroke()
  }

  /* ── Update & draw forward particles ── */
  function drawForward() {
    var c = getColors()
    var ba = baseAlpha()
    var fadeZone = progressT - 0.05
    var cs0 = c.fwdStart[0], cs1 = c.fwdStart[1], cs2 = c.fwdStart[2]
    var cd0 = c.fwdEnd[0] - cs0, cd1 = c.fwdEnd[1] - cs1, cd2 = c.fwdEnd[2] - cs2
    for (var i = 0; i < FWD_COUNT; i++) {
      var b = i * FWD_STRIDE
      if (fwd[b + 2] === 0) continue

      fwd[b] += fwd[b + 1]
      if (fwd[b] >= progressT) { fwd[b + 2] = 0; continue }

      var t = fwd[b]
      var theta = t * TOTAL_THETA + spinOffset
      var r = spiralA + spiralB * (t * TOTAL_THETA)
      var ct = Math.cos(theta), st = Math.sin(theta)
      var posX = cx + r * ct, posY = cy + r * st
      // Inline tangent + normal
      var dr = spiralB * TOTAL_THETA
      var tx = dr * ct - r * st * TOTAL_THETA
      var ty = dr * st + r * ct * TOTAL_THETA
      var len = Math.sqrt(tx * tx + ty * ty) || 1
      var d = HELIX_AMP * Math.sin(HELIX_WAVE * arcAtT(t)) + fwd[b + 3] * Math.sin(time * 2.5 + fwd[b + 4]) * 0.6
      var px = posX + (-ty / len) * d
      var py = posY + (tx / len) * d

      var a = ba
      if (t < 0.05) a = (t / 0.05) * ba
      if (fadeZone > 0 && t > fadeZone) a *= (progressT - t) / 0.05

      ctx.fillStyle = 'rgba(' + ((cs0 + cd0 * t) | 0) + ',' + ((cs1 + cd1 * t) | 0) + ',' + ((cs2 + cd2 * t) | 0) + ',' + a + ')'
      ctx.fillRect(px, py, fwd[b + 5], fwd[b + 5])
    }
  }

  /* ── Update & draw helix return particles (spiral back along strand B) ── */
  function drawReturnHelix() {
    var c = getColors()
    var ba = baseAlpha() * 0.6
    var cr0 = c.ret[0] | 0, cr1 = c.ret[1] | 0, cr2 = c.ret[2] | 0
    var retPrefix = 'rgba(' + cr0 + ',' + cr1 + ',' + cr2 + ','
    for (var i = 0; i < RH_COUNT; i++) {
      var b = i * RH_STRIDE
      if (rh[b + 2] === 0) continue

      rh[b] -= rh[b + 1]
      if (rh[b] <= 0) { rh[b + 2] = 0; continue }

      var t = rh[b]
      var theta = t * TOTAL_THETA + spinOffset
      var r = spiralA + spiralB * (t * TOTAL_THETA)
      var ct = Math.cos(theta), st = Math.sin(theta)
      var posX = cx + r * ct, posY = cy + r * st
      var dr = spiralB * TOTAL_THETA
      var tx = dr * ct - r * st * TOTAL_THETA
      var ty = dr * st + r * ct * TOTAL_THETA
      var len = Math.sqrt(tx * tx + ty * ty) || 1
      var d = HELIX_AMP * Math.sin(HELIX_WAVE * arcAtT(t) + Math.PI) + Math.sin(time * 1.5 + rh[b + 3]) * 0.6
      var px = posX + (-ty / len) * d
      var py = posY + (tx / len) * d

      var a = ba
      if (t < 0.05) a *= t / 0.05

      ctx.fillStyle = retPrefix + a + ')'
      ctx.fillRect(px, py, rh[b + 4], rh[b + 4])
    }
  }

  /* ── Sacred geometry petal returns ── */
  var geoAccum = 0

  function spawnGeo() {
    // Idle mode: particles drift from small radius back to center
    var isIdle = progressT < 0.05
    geoAccum += isIdle ? (3 + Math.random() * 2) : (12 + Math.random() * 6)
    var toSpawn = Math.floor(geoAccum)
    if (toSpawn <= 0) return
    geoAccum -= toSpawn
    for (var i = 0; i < GEO_COUNT && toSpawn > 0; i++) {
      var b = i * GEO_STRIDE
      if (geo[b + 7] === 0) {
        var pos, dist, angle
        if (isIdle) {
          // Spawn in a small halo around center
          var idleR = 30 + Math.random() * 60
          var idleA = Math.random() * Math.PI * 2
          pos = { x: cx + Math.cos(idleA) * idleR, y: cy + Math.sin(idleA) * idleR }
        } else {
          // Bias toward outer edge of reached spiral
          var r = Math.random()
          var t = r * r * progressT * 0.85
          pos = spiralPos(t)
        }
        var dx = pos.x - cx, dy = pos.y - cy
        var dist = Math.sqrt(dx * dx + dy * dy)
        var angle = Math.atan2(dy, dx)
        // Snap to nearest hexagonal axis
        var bestAxis = 0, bestDiff = Math.PI * 2
        for (var a = 0; a < GEO_AXES; a++) {
          var diff = Math.abs(angle - geoAxAngles[a])
          if (diff > Math.PI) diff = Math.PI * 2 - diff
          if (diff < bestDiff) { bestDiff = diff; bestAxis = a }
        }
        var axAngle = geoAxAngles[bestAxis]
        var sx = cx + Math.cos(axAngle) * dist
        var sy = cy + Math.sin(axAngle) * dist
        // Control point: perpendicular to radius at ~50-70% out, alternating sides
        var side = (Math.random() > 0.5) ? 1 : -1
        var perpAngle = axAngle + side * Math.PI * 0.5
        var bulge = dist * (0.4 + Math.random() * 0.3)
        var midR = dist * (0.4 + Math.random() * 0.2)
        var cpx = cx + Math.cos(axAngle) * midR + Math.cos(perpAngle) * bulge
        var cpy = cy + Math.sin(axAngle) * midR + Math.sin(perpAngle) * bulge
        geo[b]     = sx     // startX
        geo[b + 1] = sy     // startY
        geo[b + 2] = cpx    // ctrlX
        geo[b + 3] = cpy    // ctrlY
        geo[b + 4] = 0      // progress (0→1)
        geo[b + 5] = 0.005 + Math.random() * 0.008  // speed
        geo[b + 6] = side   // curve side (for visual variety)
        geo[b + 7] = 1      // active
        toSpawn--
      }
    }
  }

  function drawGeo() {
    var c = getColors()
    var ba = baseAlpha() * 0.4
    var cr0 = c.ret[0] | 0, cr1 = c.ret[1] | 0, cr2 = c.ret[2] | 0
    var geoPrefix = 'rgba(' + cr0 + ',' + cr1 + ',' + cr2 + ','
    // Cache origin once per frame
    var origin = spiralPos(0)
    var ox = origin.x, oy = origin.y
    for (var i = 0; i < GEO_COUNT; i++) {
      var b = i * GEO_STRIDE
      if (geo[b + 7] === 0) continue

      geo[b + 4] += geo[b + 5]
      if (geo[b + 4] >= 1) { geo[b + 7] = 0; continue }

      var p = geo[b + 4]
      var inv = 1 - p
      var px = inv * inv * geo[b] + 2 * inv * p * geo[b + 2] + p * p * ox
      var py = inv * inv * geo[b + 1] + 2 * inv * p * geo[b + 3] + p * p * oy

      var a = ba
      if (p < 0.1) a *= p / 0.1
      if (p > 0.8) a *= (1 - p) / 0.2

      ctx.fillStyle = geoPrefix + a + ')'
      ctx.fillRect(px, py, 1.2, 1.2)
    }
  }

  /* ── Update label carousel — smooth continuous slide ── */
  function updateLabels() {
    // Find which node we're at and how far between this and next
    activeNode = 0
    var fraction = 0
    for (var i = NODE_COUNT - 1; i >= 0; i--) {
      if (progressT >= nodeTs[i] - 0.01) {
        activeNode = i
        // Compute fraction toward next node (for smooth interpolation)
        if (i < NODE_COUNT - 1) {
          var span = nodeTs[i + 1] - nodeTs[i]
          fraction = Math.max(0, Math.min(1, (progressT - nodeTs[i]) / span))
        }
        break
      }
    }

    // Map activeNode to label index (labels are data-node 1-7, activeNode 0-7)
    // Label index for activeNode: activeNode - 1
    var activeLabelIdx = activeNode - 1
    var nextLabelIdx = activeLabelIdx + 1

    // Map progressT directly to track position — continuous, no stepping
    // Extends past last card so it scrolls up and out through the mask
    var topPad = 100
    if (labelsTrack && labelOffsets.length > 1) {
      var lastOff = labelOffsets[labelOffsets.length - 1]
      var lastCard = labels[labels.length - 1]
      var exitExtra = lastCard ? lastCard.offsetHeight + topPad + 40 : 300
      var t = Math.max(0, (progressT - nodeTs[1]) / (1 - nodeTs[1]))
      var targetY = t * (lastOff + exitExtra)
      labelsTrack.style.transform = 'translateY(' + (topPad - targetY) + 'px)'
    }

  }

  /* ── Resize ── */
  function resize() {
    var rect = wrap.getBoundingClientRect()
    dpr = Math.min(window.devicePixelRatio || 1, 2)
    W = rect.width
    H = rect.height
    canvas.width = W * dpr
    canvas.height = H * dpr
    canvas.style.width = W + 'px'
    canvas.style.height = H + 'px'
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0)
    computeSpiral()
    // Cache label top offsets within track
    labelOffsets = []
    for (var j = 0; j < labels.length; j++) {
      labelOffsets.push(labels[j].offsetTop)
    }
  }

  function debouncedResize() {
    clearTimeout(resizeTimer)
    resizeTimer = setTimeout(resize, 200)
  }
  window.addEventListener('resize', debouncedResize)

  /* ── Hover detection (node glow only) ── */
  section.addEventListener('mousemove', function(e) {
    var rect = wrap.getBoundingClientRect()
    var mx = e.clientX - rect.left
    var my = e.clientY - rect.top
    hoveredNode = -1
    for (var i = 0; i < NODE_COUNT; i++) {
      var np = nodePositions[i]
      if (!np) continue
      var dx = mx - np.x, dy = my - np.y
      if (Math.sqrt(dx * dx + dy * dy) < 40) { hoveredNode = i; break }
    }
  })
  section.addEventListener('mouseleave', function() {
    hoveredNode = -1
  })

  /* ── Scroll drives carousel naturally via progressT + lerp in updateLabels ── */

  /* ── Main loop ── */
  function tick() {
    if (!visible) { animId = 0; return }
    animId = requestAnimationFrame(tick)
    time += 0.016

    spinOffset = time * SPIN_SPEED
    prevProgressT = progressT
    progressT = getScrollProgress()

    // Kill particles beyond progress when scrolling back
    if (progressT < prevProgressT - 0.002) {
      for (var i = 0; i < FWD_COUNT; i++) {
        var b = i * FWD_STRIDE
        if (fwd[b + 2] === 1 && fwd[b] > progressT) fwd[b + 2] = 0
      }
      for (var i = 0; i < RH_COUNT; i++) {
        var b = i * RH_STRIDE
        if (rh[b + 2] === 1 && rh[b] > progressT) rh[b + 2] = 0
      }
      for (var i = 0; i < GEO_COUNT; i++) {
        var b = i * GEO_STRIDE
        if (geo[b + 7] === 1) geo[b + 7] = 0
      }
    }

    ctx.clearRect(0, 0, W, H)

    spawnFwd()
    spawnRetHelix()
    spawnGeo()
    drawSpiralPath()
    drawGeo()
    drawForward()
    drawReturnHelix()
    updateLabels()
  }

  /* ── Visibility gating ── */
  new IntersectionObserver(function(entries) {
    for (var i = 0; i < entries.length; i++) {
      if (entries[i].isIntersecting) {
        visible = true
        if (!animId) { resize(); animId = requestAnimationFrame(tick) }
      } else {
        visible = false
      }
    }
  }, { threshold: 0.01 }).observe(scrollOuter)

  /* ── Theme reactivity ── */
  new MutationObserver(function() {
    if (visible) resize()
  }).observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] })
})()
</script>


